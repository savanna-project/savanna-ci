- job:
    name: savanna-cd
    node: savanna-cd
    project-type: freestyle
    description: "<b>Title</b>: Savanna Continuous Delivery to Saratov lab<br/>\
                \n<b>Description</b>: This job configures and starts individual Savanna per each created patch set and one Savanna for the latest master.<br/>\
                \n<b>Maintainer</b>: Denis Egorenko<br/>"
    defaults: global
    disabled: true
    concurrent: false

    scm:
     - git:
        url: ssh://savanna-ci@review.openstack.org:29418/stackforge/savanna.git
        refspec: $GERRIT_REFSPEC
        name:
        skip-tag: true
        wipe-workspace: false
        basedir: "savanna_$GERRIT_CHANGE_NUMBER"
        strategy: gerrit
        branches:
         - master

    triggers:
        - gerrit:
            trigger-on-patchset-uploaded-event: true
            trigger-on-change-merged-event: true
            failure-message:
            successful-message: "Savanna is running successfully for this change request and available by address 172.18.79.219:<CHANGE>. For change merged you can use: 172.18.79.219:8080"
            projects:
                - project-compare-type: 'PLAIN'
                  project-pattern: 'stackforge/savanna'
                  branch-compare-type: 'PLAIN'
                  branch-pattern: 'master'

    builders:
    - shell: "\
             #!/bin/bash\
             \nBUILD_ID=dontKill\
             \necho -e \"[global]\
             \ntimeout = 60\
             \nindex-url = http://savanna-ci.vm.mirantis.net/pypi/savanna/\
             \nextra-index-url = https://pypi.python.org/simple/\
             \ndownload-cache = /home/ubuntu/.pip/cache/\
             \n[install]\
             \nuse-mirrors = true\
             \nfind-links = http://savanna-ci.vm.mirantis.net:8181/simple/\" > ~/.pip/pip.conf\
             \n
             \ncd $WORKSPACE/savanna_$GERRIT_CHANGE_NUMBER\
             \n\
             \necho -e \"[DEFAULT]\
             \n#REST API config\
             \n#port=8080\
             \n#allow_cluster_ops=true\
             \n# Address and credentials that will be used to check auth tokens\
             \nos_auth_host=172.18.79.139\
             \nos_auth_port=35357\
             \n#os_admin_username=admin\
             \nos_admin_password=swordfish\
             \n#os_admin_tenant_name=admin\
             \n# (Optional) Name of log file to output to. If not set,\
             \n# logging will go to stdout. (string value)\
             \n#log_file=<None>\
             \nplugins=vanilla\
             \n[cluster_node]\
             \n# An existing user on Hadoop image (string value)\
             \n#username=root\
             \n# User's password (string value)\
             \n#password=swordfish\
             \n# When set to false, Savanna uses only internal IP of VMs.\
             \n# When set to true, Savanna expects OpenStack to auto-assign\
             \n# floating IPs to cluster nodes. Internal IPs will be used for\
             \n# inter-cluster communication, while floating ones will be\
             \n# used by Savanna to configure nodes. Also floating IPs will\
             \n# be exposed in service URLs (boolean value)\
             \n#use_floating_ips=true\
             \n[database]\
             \n# URL for sqlalchemy database (string value)\
             \nconnection=sqlite:////tmp/savanna-server-$GERRIT_CHANGE_NUMBER.db\
             \n[plugin:vanilla]\
             \nplugin_class=savanna.plugins.vanilla.plugin:VanillaProvider\" > etc/savanna/savanna.conf\
             \n\
             \nexist=`screen -ls | grep Savanna-$GERRIT_CHANGE_NUMBER`\
             \nif ! [ -z \"$exist\" ]\
             \nthen\
             \n    screen -X -S Savanna-$GERRIT_CHANGE_NUMBER quit\
             \nfi\
             \nif [ $GERRIT_EVENT_TYPE != \"patchset-created\" ]\
             \nthen\
             \n    exist=`screen -ls | grep Savanna-8080`\
             \n    if ! [ -z \"$exist\" ]\
             \n    then\
             \n        screen -X -S Savanna-8080 quit\
             \n    fi\
             \n    screen -dmS Savanna-8080\
             \n    sleep 2\
             \n    screen -S Savanna-8080 -p 0 -X stuff 'tox -evenv -- savanna-api --config-file etc/savanna/savanna.conf -d\
             \n'\
             \nelse\
             \n    screen -dmS Savanna-$GERRIT_CHANGE_NUMBER\
             \n    sleep 2\
             \n    screen -S Savanna-$GERRIT_CHANGE_NUMBER -p 0 -X stuff \"tox -evenv -- savanna-api --config-file etc/savanna/savanna.conf --port $GERRIT_CHANGE_NUMBER -d\
             \n\"\
             \nfi"

    publishers:
      - email:
          recipients: degorenko@mirantis.com
